stages:
  - test
  - build
  - docker
  - pages

variables:
  TOOL_NAME: {{ tool_name }}
  GO_VERSION: "1.23"

# Cache Go modules between jobs
.go-cache:
  variables:
    GOPATH: $CI_PROJECT_DIR/.go
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - .go/pkg/mod/

# Test stage - runs on all merge requests and tags
lint:
  stage: test
  image: golangci/golangci-lint:latest
  extends: .go-cache
  script:
    - cd src/${TOOL_NAME}
    - golangci-lint run --timeout 5m
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_TAG

test:
  stage: test
  image: golang:${GO_VERSION}
  extends: .go-cache
  script:
    - cd src/${TOOL_NAME}
    - go test -race -cover -v ./...
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_TAG

# Build stage - verify compilation
build:
  stage: build
  image: golang:${GO_VERSION}
  extends: .go-cache
  script:
    - cd src/${TOOL_NAME}
    - go build -o ../../bin/${TOOL_NAME} .
  artifacts:
    paths:
      - bin/
    expire_in: 1 hour
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_TAG

# Docker stage - build and push on tags only
docker:
  stage: docker
  image: docker:latest
  services:
    - docker:dind
  variables:
    DOCKER_TAG: ${CI_REGISTRY_IMAGE}/${TOOL_NAME}:${CI_COMMIT_TAG}
    DOCKER_LATEST: ${CI_REGISTRY_IMAGE}/${TOOL_NAME}:latest
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - |
      docker build \
        --build-arg VERSION=${CI_COMMIT_TAG} \
        --build-arg COMMIT=${CI_COMMIT_SHORT_SHA} \
        --build-arg BUILD_DATE=$(date -u +%Y-%m-%dT%H:%M:%SZ) \
        -t $DOCKER_TAG \
        -f docker/Dockerfile.${TOOL_NAME} .
    - docker push $DOCKER_TAG
    # Tag as latest for semver tags (v*)
    - |
      if echo "$CI_COMMIT_TAG" | grep -qE '^v[0-9]+\.[0-9]+'; then
        docker tag $DOCKER_TAG $DOCKER_LATEST
        docker push $DOCKER_LATEST
      fi
  rules:
    - if: $CI_COMMIT_TAG

# Pages stage - deploy docs on main branch
pages:
  stage: pages
  image: ghcr.io/astral-sh/uv:python3.12-bookworm
  script:
    - uv sync
    - uv run mkdocs build
  artifacts:
    paths:
      - public
  rules:
    - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH
