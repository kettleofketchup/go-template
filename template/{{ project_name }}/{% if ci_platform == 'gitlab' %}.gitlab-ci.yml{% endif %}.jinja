stages:
  - test
  - build
  - docker
  - pages

variables:
  TOOL_NAME: {{ tool_name }}
  GO_VERSION: "1.23"

# Cache Go modules between jobs
.go-cache:
  variables:
    GOPATH: $CI_PROJECT_DIR/.go
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - .go/pkg/mod/

.just-setup:
  before_script:
    - curl --proto '=https' --tlsv1.2 -sSf https://just.systems/install.sh | bash -s -- --to /usr/local/bin

# Test stage
lint:
  stage: test
  image: golangci/golangci-lint:latest
  extends: [.go-cache, .just-setup]
  script:
    - just cicd::lint
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_TAG

test:
  stage: test
  image: golang:${GO_VERSION}
  extends: [.go-cache, .just-setup]
  script:
    - just cicd::test
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_TAG

# Build stage
build:
  stage: build
  image: golang:${GO_VERSION}
  extends: [.go-cache, .just-setup]
  script:
    - just cicd::build
  artifacts:
    paths:
      - bin/
    expire_in: 1 hour
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_TAG

# Docker stage
docker:
  stage: docker
  image: docker:latest
  services:
    - docker:dind
  variables:
    DOCKER_TAG: ${CI_REGISTRY_IMAGE}/${TOOL_NAME}:${CI_COMMIT_TAG}
    DOCKER_LATEST: ${CI_REGISTRY_IMAGE}/${TOOL_NAME}:latest
  before_script:
    - apk add --no-cache curl bash
    - curl --proto '=https' --tlsv1.2 -sSf https://just.systems/install.sh | bash -s -- --to /usr/local/bin
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - just cicd::docker $DOCKER_TAG
    - docker push $DOCKER_TAG
    - |
      if echo "$CI_COMMIT_TAG" | grep -qE '^v[0-9]+\.[0-9]+'; then
        docker tag $DOCKER_TAG $DOCKER_LATEST
        docker push $DOCKER_LATEST
      fi
  rules:
    - if: $CI_COMMIT_TAG

# Pages stage
pages:
  stage: pages
  image: ghcr.io/astral-sh/uv:python3.12-bookworm
  before_script:
    - apt-get update && apt-get install -y curl
    - curl --proto '=https' --tlsv1.2 -sSf https://just.systems/install.sh | bash -s -- --to /usr/local/bin
  script:
    - just cicd::pages
  artifacts:
    paths:
      - public
  rules:
    - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH
