# CI/CD recipes - platform-agnostic build commands
# Call as: just cicd::lint, just cicd::test, etc.

TOOL_NAME := "{{ tool_name }}"
TOOL_FOLDER := env_var("PWD") + "/src/" + TOOL_NAME
BIN_DIR := env_var("PWD") + "/bin"

VERSION := `git describe --tags --always 2>/dev/null || echo "dev"`
COMMIT := `git rev-parse --short HEAD 2>/dev/null || echo "unknown"`
DATE := `date -u +%Y-%m-%dT%H:%M:%SZ`

{% if ci_platform == 'gitlab' -%}
DOCKER_REGISTRY := "{{ gitlab_registry }}"
{%- else -%}
DOCKER_REGISTRY := "{{ github_registry }}"
{%- endif %}
DOCKER_TAG := DOCKER_REGISTRY + "/" + TOOL_NAME + ":" + VERSION

# Run linter
lint:
    @echo "Running linter..."
    cd {{ '{{' }} TOOL_FOLDER {{ '}}' }} && golangci-lint run --timeout 5m

# Run tests with race detection and coverage
test:
    @echo "Running tests..."
    cd {{ '{{' }} TOOL_FOLDER {{ '}}' }} && go test -race -cover -v ./...

# Build the binary
build:
    @echo "Building binary..."
    @mkdir -p {{ '{{' }} BIN_DIR {{ '}}' }}
    cd {{ '{{' }} TOOL_FOLDER {{ '}}' }} && go build -o {{ '{{' }} BIN_DIR {{ '}}' }}/{{ '{{' }} TOOL_NAME {{ '}}' }} .

# Build docker image
docker tag=DOCKER_TAG:
    @echo "Building Docker image..."
    docker build \
        --build-arg VERSION={{ '{{' }} VERSION {{ '}}' }} \
        --build-arg COMMIT={{ '{{' }} COMMIT {{ '}}' }} \
        --build-arg BUILD_DATE={{ '{{' }} DATE {{ '}}' }} \
        -t {{ '{{' }} tag {{ '}}' }} \
        -f docker/Dockerfile.{{ '{{' }} TOOL_NAME {{ '}}' }} .

# Push docker image
docker-push tag=DOCKER_TAG: (docker tag)
    @echo "Pushing Docker image..."
    docker push {{ '{{' }} tag {{ '}}' }}

# Build documentation to public/
pages:
    @echo "Building documentation..."
    uv sync
    uv run mkdocs build
