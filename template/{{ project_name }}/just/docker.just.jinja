# Docker build and push recipes
# Call as: just docker::build, just docker::push, etc.

TOOL_NAME := "{{ tool_name }}"
PROJECT_ROOT := env_var("PWD")
VERSION := `git describe --tags --always 2>/dev/null || echo "dev"`
COMMIT := `git rev-parse --short HEAD 2>/dev/null || echo "unknown"`
DATE := `date -u +%Y-%m-%dT%H:%M:%SZ`

DOCKER_REGISTRY := "{{ gitlab_registry }}"
DOCKER_TAG := DOCKER_REGISTRY + "/" + TOOL_NAME + ":" + VERSION
DOCKER_LATEST := DOCKER_REGISTRY + "/" + TOOL_NAME + ":latest"
DOCKERFILE := PROJECT_ROOT + "/docker/Dockerfile." + TOOL_NAME

# Login to GitLab registry
login:
    @echo "Logging into GitLab registry..."
    docker login {{ gitlab_url }}:5050

# Build Docker image
build:
    @echo "Building Docker image..."
    cd {{ '{{' }} PROJECT_ROOT {{ '}}' }} && docker build \
        --build-arg VERSION={{ '{{' }} VERSION {{ '}}' }} \
        --build-arg COMMIT={{ '{{' }} COMMIT {{ '}}' }} \
        --build-arg BUILD_DATE={{ '{{' }} DATE {{ '}}' }} \
        -t {{ '{{' }} DOCKER_TAG {{ '}}' }} \
        -f {{ '{{' }} DOCKERFILE {{ '}}' }} .
    docker tag {{ '{{' }} DOCKER_TAG {{ '}}' }} {{ '{{' }} DOCKER_LATEST {{ '}}' }}
    @echo "Built: {{ '{{' }} DOCKER_TAG {{ '}}' }}"

# Push Docker image to registry
push: build
    @echo "Pushing Docker image..."
    docker push {{ '{{' }} DOCKER_TAG {{ '}}' }}
    docker push {{ '{{' }} DOCKER_LATEST {{ '}}' }}
