# Build stage
FROM golang:1.23-bookworm AS builder

WORKDIR /build

# Copy go mod files first for caching
COPY src/{{ tool_name }}/go.mod src/{{ tool_name }}/go.sum* ./src/{{ tool_name }}/
RUN cd src/{{ tool_name }} && go mod download

# Copy source code
COPY src/{{ tool_name }}/ ./src/{{ tool_name }}/

# Build arguments for version injection
ARG VERSION=dev
ARG COMMIT=unknown
ARG BUILD_DATE=unknown

# Build the binary
RUN cd src/{{ tool_name }} && \
    CGO_ENABLED=0 GOOS=linux go build -trimpath \
    -ldflags "-s -w \
        -X {{ gitlab_url }}/{{ project_name }}/src/{{ tool_name }}/version.Version=${VERSION} \
        -X {{ gitlab_url }}/{{ project_name }}/src/{{ tool_name }}/version.Commit=${COMMIT} \
        -X {{ gitlab_url }}/{{ project_name }}/src/{{ tool_name }}/version.BuildDate=${BUILD_DATE}" \
    -o /{{ tool_name }} .

# Runtime stage
FROM debian:bookworm-slim

RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# Add custom certificates (if any)
COPY docker/certificates/ /tmp/certs/
RUN if ls /tmp/certs/*.pem 1>/dev/null 2>&1; then \
        cp /tmp/certs/*.pem /usr/local/share/ca-certificates/ && \
        update-ca-certificates; \
    fi && rm -rf /tmp/certs

# Copy binary from builder
COPY --from=builder /{{ tool_name }} /usr/local/bin/{{ tool_name }}

ENTRYPOINT ["{{ tool_name }}"]
